# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHáº¦N 8 MAIN WORKFLOW
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def export_prompts_to_file()
    Xuáº¥t táº¥t cáº£ prompts tá»•ng quan ra file text
    output = []
    output.append(=  100)
    output.append(ğŸ“ PROMPTS Tá»”NG QUAN - TRUYá»†N TRANH Ká»¶ NIá»†M 80 NÄ‚M QUá»C KHÃNH 29)
    output.append(=  100)
    output.append()
    
    for page_num in sorted(PAGE_PROMPTS.keys())
        page_info = PAGE_PROMPTS[page_num]
        output.append(fn{'='  100})
        output.append(fğŸ¨ {page_info['title']})
        output.append(f{'='  100})
        output.append(fnğŸ“– MÃ” Táº¢ {page_info['description']})
        output.append(fğŸ­ TÃ‚M TRáº NG {page_info['mood']})
        output.append(fnğŸ“ CÃC PANELS)
        
        for i, panel_desc in enumerate(page_info['panels'], 1)
            output.append(f  {i}. {panel_desc})
        
        output.append()
    
    output.append(n + =  100)
    output.append(ğŸ’¡ HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG)
    output.append(=  100)
    output.append(
- Má»—i trang cÃ³ mÃ´ táº£ tá»•ng quan vÃ  chi tiáº¿t tá»«ng panel
- Prompts Ä‘Æ°á»£c viáº¿t sáºµn phÃ¹ há»£p vá»›i chá»§ Ä‘á» Quá»‘c khÃ¡nh Viá»‡t Nam
- NhÃ¢n váº­t An, BÃ¬nh, Chi, DÅ©ng - 4 há»c sinh THPT
- Phong cÃ¡ch Manhwa hiá»‡n Ä‘áº¡i, mÃ u sáº¯c tÆ°Æ¡i sÃ¡ng
- Bá»‘i cáº£nh TrÆ°á»ng há»c Viá»‡t Nam, cá» Ä‘á» sao vÃ ng

ğŸ¯ Má»¤C ÄÃCH
- GiÃ¡o dá»¥c Ã½ nghÄ©a ngÃ y Quá»‘c khÃ¡nh 291945
- Thá»ƒ hiá»‡n tinh tháº§n yÃªu nÆ°á»›c cá»§a tháº¿ há»‡ tráº»
- CÃ¡c hoáº¡t Ä‘á»™ng ká»· niá»‡m ChÃ o cá», triá»ƒn lÃ£m, vÄƒn nghá»‡
- Truyá»n cáº£m há»©ng há»c táº­p vÃ  Ä‘Ã³ng gÃ³p cho Ä‘áº¥t nÆ°á»›c

ğŸ‡»ğŸ‡³ Ká»· niá»‡m 80 nÄƒm Quá»‘c khÃ¡nh Viá»‡t Nam 291945 - 292025
)
    
    prompt_file = PROMPTS_TONG_QUAN_QUOC_KHANH.txt
    with open(prompt_file, w, encoding=utf-8) as f
        f.write(n.join(output))
    
    print(fnâœ… ÄÃ£ xuáº¥t prompts ra file {prompt_file})
    return prompt_file


def main()
    Quy trÃ¬nh chÃ­nh táº¡o truyá»‡n tranh
    print(=  80)
    print(ğŸ‡»ğŸ‡³ Há»† THá»NG Táº O TRUYá»†N TRANH - Ká»¶ NIá»†M 80 NÄ‚M QUá»C KHÃNH 29)
    print(=  80)
    
    # âœ¨ KIá»‚M TRA RESUME - CÃ³ file táº¡m khÃ´ng
    temp_script_file = story_script_TEMP.json
    structure_file = comic_structure.json
    
    story_script = None
    selected_layouts = None
    resume_mode = False
    
    if os.path.exists(temp_script_file) and os.path.exists(structure_file)
        print(nğŸ”„ PHÃT HIá»†N SESSION TRÆ¯á»šC ÄÃ“)
        print(f   ğŸ“„ Ká»‹ch báº£n {temp_script_file})
        print(f   ğŸ“ Layouts {structure_file})
        
        resume_choice = input(nâ“ Tiáº¿p tá»¥c tá»« chá»— cÅ© (y=CÃ³n=Báº¯t Ä‘áº§u má»›i) ).strip().lower()
        
        if resume_choice == 'y'
            # Load dá»¯ liá»‡u cÅ©
            try
                with open(temp_script_file, r, encoding=utf-8) as f
                    story_script = json.load(f)
                with open(structure_file, r, encoding=utf-8) as f
                    selected_layouts = json.load(f)
                
                print(âœ… ÄÃ£ táº£i session trÆ°á»›c!)
                print(f   ğŸ“š Truyá»‡n {story_script.get('title', 'NA')})
                print(f   ğŸ“„ Sá»‘ trang {len(story_script.get('pages', []))})
                print(f   ğŸ“ Layouts {len(selected_layouts)} trang)
                
                resume_mode = True
                
            except Exception as e
                print(fâŒ Lá»—i load file {e})
                print(âš ï¸ Sáº½ báº¯t Ä‘áº§u session má»›i...)
                resume_mode = False
    
    if not resume_mode
        # BÆ°á»›c 0 Xuáº¥t prompts tá»•ng quan
        print(nğŸ“ Äang xuáº¥t prompts tá»•ng quan...)
        prompt_file = export_prompts_to_file()
        print(fğŸ“„ Xem file '{prompt_file}' Ä‘á»ƒ biáº¿t chi tiáº¿t tá»«ng trangpanel)
        print(fğŸ“„ Xem file '{prompt_file}' Ä‘á»ƒ biáº¿t chi tiáº¿t tá»«ng trangpanel)
    
        # BÆ°á»›c 1 Nháº­p sá»‘ trang
        try
            num_pages_input = input(nğŸ“– Nháº­p sá»‘ trang truyá»‡n (khuyáº¿n nghá»‹ 3-5 trang) )
            num_pages = int(num_pages_input)
            if num_pages  1 or num_pages  10
                print(âš ï¸ Sá»‘ trang nÃªn tá»« 1-10. Äáº·t máº·c Ä‘á»‹nh = 5)
                num_pages = 5
        except
            print(âš ï¸ Nháº­p khÃ´ng há»£p lá»‡. Äáº·t máº·c Ä‘á»‹nh = 5 trang)
            num_pages = 5
        
        # BÆ°á»›c 2 Chá»n layouts
        print(fnğŸ“ Chá»n layouts cho {num_pages + 1} trang (bao gá»“m trang demo)...)
        selected_layouts = select_layouts(num_pages)
        
        print(fâœ… ÄÃ£ chá»n layouts)
        for page in selected_layouts
            tag =  [DEMO] if page.get('is_demo') else 
            print(f   Trang {page['page_num']} {page['layout_name']} ({len(page['panels'])} khung){tag})
        
        # LÆ°u structure
        with open(structure_file, w, encoding=utf-8) as f
            json.dump(selected_layouts, f, indent=2, ensure_ascii=False)
        
        # BÆ°á»›c 3 Sinh ká»‹ch báº£n
        print(fnğŸ¤– Äang sinh ká»‹ch báº£n vá»›i Gemini AI...)
        print(ğŸ“ Sá»­ dá»¥ng ká»‹ch báº£n máº·c Ä‘á»‹nh vá» Quá»‘c khÃ¡nh...)
        
        script_accepted = False
        
        while not script_accepted
            # Sinh ká»‹ch báº£n
            story_script = generate_story_script(DEFAULT_STORY, selected_layouts)
            
            if not story_script
                print(âŒ KhÃ´ng thá»ƒ sinh ká»‹ch báº£n. Dá»«ng chÆ°Æ¡ng trÃ¬nh.)
                return
            
            # LÆ°u ká»‹ch báº£n táº¡m
            with open(temp_script_file, w, encoding=utf-8) as f
                json.dump(story_script, f, indent=2, ensure_ascii=False)
            
            # Hiá»ƒn thá»‹ tÃ³m táº¯t ká»‹ch báº£n
            print(n + =  80)
            print(ğŸ“– Ká»ŠCH Báº¢N Vá»ªA SINH)
            print(=  80)
            print(fğŸ“š TÃªn truyá»‡n {story_script['title']})
            print(fğŸ¨ Phong cÃ¡ch {story_script['art_style']})
            print(fğŸ‘¥ NhÃ¢n váº­t {len(story_script['characters'])} nhÃ¢n váº­t)
            print(fnğŸ‘¤ Danh sÃ¡ch nhÃ¢n váº­t)
            for char in story_script['characters']
                print(f   - {char['name']} {char['description'][80]}...)
            
            print(fnğŸ“„ Tá»•ng quan cÃ¡c trang)
            for page in story_script['pages']
                page_tag =  [DEMO] if page.get('is_demo') else 
                print(fn   ğŸ“– Trang {page['page_num']}{page_tag} {page.get('scene_description', 'NA')})
                print(f      Sá»‘ panels {len(page['panels'])})
                
                # Hiá»ƒn thá»‹ 2 panel Ä‘áº§u tiÃªn
                for i, panel in enumerate(page['panels'][2])
                    dialogue = panel.get('dialogue', 'KhÃ´ng cÃ³ lá»i thoáº¡i')
                    visual = panel.get('visual_prompt', 'NA')[60]
                    print(f      â€¢ Panel {panel['panel_num']} {dialogue})
                    print(f        Visual {visual}...)
                
                if len(page['panels'])  2
                    print(f      â€¢ ... vÃ  {len(page['panels']) - 2} panels khÃ¡c)
            
            print(n + =  80)
            print(fğŸ“ Ká»‹ch báº£n chi tiáº¿t Ä‘Ã£ lÆ°u táº¡i {os.path.abspath(temp_script_file)})
            print(=  80)
            
            # Há»i ngÆ°á»i dÃ¹ng
            print(nğŸ“ Báº N CÃ“ THá»‚)
            print(   1. Nháº¥n 'y' - Cháº¥p nháº­n ká»‹ch báº£n nÃ y vÃ  báº¯t Ä‘áº§u táº¡o áº£nh)
            print(   2. Nháº¥n 'e' - Má»Ÿ file JSON Ä‘á»ƒ CHá»ˆNH Sá»¬A ká»‹ch báº£n)
            print(   3. Nháº¥n 'r' - Táº O Láº I ká»‹ch báº£n hoÃ n toÃ n má»›i)
            print(   4. Nháº¥n 'q' - ThoÃ¡t chÆ°Æ¡ng trÃ¬nh)
            
            while True
                choice = input(nâ“ Lá»±a chá»n cá»§a báº¡n (yerq) ).strip().lower()
                
                if choice == 'y'
                    # Cháº¥p nháº­n - lÆ°u vÄ©nh viá»…n
                    final_script_file = story_script.json
                    with open(final_script_file, w, encoding=utf-8) as f
                        json.dump(story_script, f, indent=2, ensure_ascii=False)
                    print(fâœ… ÄÃ£ cháº¥p nháº­n ká»‹ch báº£n! LÆ°u táº¡i {final_script_file})
                    script_accepted = True
                    break
                    
                elif choice == 'e'
                    # Chá»‰nh sá»­a
                    print(fnğŸ“ HÆ¯á»šNG DáºªN CHá»ˆNH Sá»¬A)
                    print(f   1. Má»Ÿ file {os.path.abspath(temp_script_file)})
                    print(f   2. Chá»‰nh sá»­a ná»™i dung theo Ã½ muá»‘n)
                    print(f      - Thay Ä‘á»•i 'dialogue' Ä‘á»ƒ sá»­a lá»i thoáº¡i)
                    print(f      - Thay Ä‘á»•i 'visual_prompt' Ä‘á»ƒ sá»­a mÃ´ táº£ hÃ¬nh áº£nh)
                    print(f      - Thay Ä‘á»•i 'scene_description' Ä‘á»ƒ sá»­a mÃ´ táº£ cáº£nh)
                    print(f   3. LÆ¯U FILE (Ctrl+S))
                    print(f   4. Quay láº¡i Ä‘Ã¢y vÃ  nháº¥n Enter Ä‘á»ƒ tiáº¿p tá»¥c)
                    
                    input(nâ¸ï¸  Nháº¥n Enter sau khi Ä‘Ã£ CHá»ˆNH Sá»¬A vÃ  LÆ¯U file...)
                    
                    # Äá»c láº¡i file Ä‘Ã£ chá»‰nh sá»­a
                    try
                        with open(temp_script_file, r, encoding=utf-8) as f
                            story_script = json.load(f)
                        
                        print(âœ… ÄÃ£ táº£i láº¡i ká»‹ch báº£n Ä‘Ã£ chá»‰nh sá»­a!)
                        
                        # LÆ°u vÃ o file chÃ­nh thá»©c
                        final_script_file = story_script.json
                        with open(final_script_file, w, encoding=utf-8) as f
                            json.dump(story_script, f, indent=2, ensure_ascii=False)
                        
                        script_accepted = True
                        break
                        
                    except json.JSONDecodeError as e
                        print(fâŒ Lá»—i File JSON khÃ´ng há»£p lá»‡ - {e})
                        print(âš ï¸  Vui lÃ²ng kiá»ƒm tra láº¡i cÃº phÃ¡p JSON)
                        retry = input(Nháº¥n 'r' Ä‘á»ƒ thá»­ láº¡i, 'c' Ä‘á»ƒ há»§y chá»‰nh sá»­a ).strip().lower()
                        if retry == 'c'
                            print(âª Quay láº¡i ká»‹ch báº£n gá»‘c...)
                            break
                        # Náº¿u 'r' thÃ¬ tiáº¿p tá»¥c vÃ²ng láº·p Ä‘á»ƒ ngÆ°á»i dÃ¹ng sá»­a láº¡i
                        
                elif choice == 'r'
                    # Táº¡o láº¡i
                    print(ğŸ”„ Äang táº¡o láº¡i ká»‹ch báº£n má»›i...)
                    break
                    
                elif choice == 'q'
                    print(ğŸ‘‹ ThoÃ¡t chÆ°Æ¡ng trÃ¬nh.)
                    return
                    
                else
                    print(âš ï¸  Vui lÃ²ng nháº­p 'y', 'e', 'r', hoáº·c 'q')
    
    # âœ¨ VALIDATION Náº¿u resume mode, bá» qua pháº§n script review
    if not resume_mode
        # Validation panels
        print(nğŸ” Kiá»ƒm tra sá»‘ panels...)
        for page in story_script['pages']
            page_num = page['page_num']
            
            # TÃ¬m layout tÆ°Æ¡ng á»©ng vá»›i page_num
            layout_info = None
            for layout in selected_layouts
                if layout['page_num'] == page_num
                    layout_info = layout
                    break
            
            if not layout_info
                print(f   âš ï¸ Trang {page_num} KhÃ´ng tÃ¬m tháº¥y layout!)
                continue
            
            expected = len(layout_info['panels'])
            actual = len(page['panels'])
            
            if actual != expected
                print(f   âš ï¸ Trang {page_num} {actual} â†’ {expected} panels)
                if actual  expected
                    page['panels'] = page['panels'][expected]
                else
                    while len(page['panels'])  expected
                        last_panel = page['panels'][-1].copy()
                        last_panel['panel_num'] = len(page['panels']) + 1
                        page['panels'].append(last_panel)
            else
                print(f   âœ… Trang {page_num} {actual} panels)
    else
        print(nâ™»ï¸  Sá»­ dá»¥ng ká»‹ch báº£n vÃ  layouts tá»« session trÆ°á»›c...)
    
    # LÆ°u script
    with open(story_script.json, w, encoding=utf-8) as f
        json.dump(story_script, f, indent=2, ensure_ascii=False)
    
    print(fnâœ… Ká»‹ch báº£n {story_script['title']})
    print(f   Phong cÃ¡ch {story_script['art_style']})
    print(f   NhÃ¢n váº­t {len(story_script['characters'])})
    
    # BÆ°á»›c 4 Táº¡o panel images
    print(n + =  80)
    print(ğŸ¨ Táº O áº¢NH CHO Tá»ªNG PANEL)
    print(=  80)
    
    panel_images = create_panel_images(story_script, selected_layouts)
    
    total_panels = sum([len(p) for p in panel_images.values()])
    print(fnâœ… ÄÃ£ táº¡o {total_panels} panels!)
    
    # BÆ°á»›c 5 GhÃ©p trang
    print(nğŸ“„ GhÃ©p panels thÃ nh trang...)
    os.makedirs(final_comic, exist_ok=True)
    
    final_pages = []
    demo_page_path = None
    
    for page_num in sorted(panel_images.keys())
        panels = panel_images[page_num]
        print(f   GhÃ©p trang {page_num}...)
        
        page_img = compose_page(page_num, panels)
        
        if page_num == 0
            page_path = final_comicpage_00_DEMO_CHARACTER_REFERENCE.png
            demo_page_path = page_path
        else
            page_path = ffinal_comicpage_{page_num02d}.png
            final_pages.append(page_path)
        
        page_img.save(page_path, quality=95)
        print(f   âœ… LÆ°u {page_path})
    
    # BÆ°á»›c 6 Táº¡o PDF
    print(nğŸ“„ Táº¡o PDF...)
    pdf_file = create_comic_pdf(final_pages)
    
    # BÆ°á»›c 7 Táº¡o README
    if story_script and final_pages
        readme_content = f# {story_script['title']}

## ThÃ´ng tin
- Chá»§ Ä‘á» Ká»· niá»‡m 80 nÄƒm Quá»‘c khÃ¡nh Viá»‡t Nam 291945 - 292025
- Phong cÃ¡ch {story_script['art_style']}
- Sá»‘ trang {len(final_pages)} trang
- NhÃ¢n váº­t {', '.join([c['name'] for c in story_script['characters']])}
- Táº¡o lÃºc {time.strftime(%Y-%m-%d %H%M%S)}

## Ná»™i dung
Truyá»‡n tranh vá» nhÃ³m há»c sinh chuáº©n bá»‹ vÃ  tham gia cÃ¡c hoáº¡t Ä‘á»™ng ká»· niá»‡m 80 nÄƒm Quá»‘c khÃ¡nh,
thá»ƒ hiá»‡n tinh tháº§n yÃªu nÆ°á»›c vÃ  tá»± hÃ o dÃ¢n tá»™c cá»§a tháº¿ há»‡ tráº» Viá»‡t Nam.

## Files
- `QUOC_KHANH_80_NAM.pdf` - Truyá»‡n hoÃ n chá»‰nh (PDF)
- `page_01.png` Ä‘áº¿n `page_{len(final_pages)02d}.png` - Tá»«ng trang
- `page_00_DEMO_CHARACTER_REFERENCE.png` - Trang giá»›i thiá»‡u nhÃ¢n váº­t
- `story_script.json` - Ká»‹ch báº£n chi tiáº¿t
- `comic_structure.json` - Cáº¥u trÃºc layouts

---
Táº¡o bá»Ÿi Quá»‘c KhÃ¡nh Comic Generator
Chá»§ Ä‘á» 80 nÄƒm Quá»‘c khÃ¡nh Viá»‡t Nam ğŸ‡»ğŸ‡³

        
        with open(final_comicREADME.md, w, encoding=utf-8) as f
            f.write(readme_content)
    
    # Káº¿t thÃºc
    print(n + =  80)
    print(ğŸ‰ HOÃ€N THÃ€NH!)
    print(=  80)
    print(fnğŸ“š Truyá»‡n {story_script['title']})
    print(fğŸ“ Folder final_comic)
    print(fğŸ“„ PDF {pdf_file if pdf_file else 'KhÃ´ng táº¡o Ä‘Æ°á»£c'})
    print(fğŸ–¼ï¸ Trang {len(final_pages)} trang truyá»‡n)
    print(nğŸ‡»ğŸ‡³ Chá»§ Ä‘á» Ká»· niá»‡m 80 nÄƒm Quá»‘c khÃ¡nh 291945 - 292025)
    print(=  80)


if __name__ == __main__
    main()
