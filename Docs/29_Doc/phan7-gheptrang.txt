# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# PH·∫¶N 7: GH√âP TRANG & XU·∫§T PDF
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

def compose_page(page_num, panels):
    """Gh√©p panels th√†nh trang"""
    page_img = Image.new("RGB", (PAGE_W, PAGE_H), "white")
    
    for panel in panels:
        x, y, w, h = panel['position']
        page_img.paste(panel['image'], (x, y))
    
    draw = ImageDraw.Draw(page_img)
    for panel in panels:
        x, y, w, h = panel['position']
        draw.rectangle([x, y, x+w, y+h], outline="black", width=5)
    
    return page_img


def create_comic_pdf(final_pages, output_filename="final_comic/QUOC_KHANH_80_NAM.pdf"):
    """T·∫°o PDF t·ª´ c√°c trang"""
    try:
        if not final_pages:
            print("‚ùå Kh√¥ng c√≥ trang ƒë·ªÉ t·∫°o PDF")
            return None
        
        print(f"\nüìÑ T·∫°o PDF t·ª´ {len(final_pages)} trang...")
        
        images = []
        for i, page_path in enumerate(final_pages):
            print(f"   ƒê·ªçc trang {i+1}/{len(final_pages)}")
            img = Image.open(page_path)
            if img.mode != 'RGB':
                img = img.convert('RGB')
            images.append(img)
        
        if len(images) > 0:
            print(f"\nüíæ L∆∞u PDF: {output_filename}")
            images[0].save(
                output_filename,
                save_all=True,
                append_images=images[1:] if len(images) > 1 else [],
                resolution=300.0,
                quality=95,
                optimize=False
            )
            
            file_size = os.path.getsize(output_filename) / (1024 * 1024)
            print(f"‚úÖ PDF ho√†n th√†nh! {file_size:.2f} MB, {len(images)} trang")
            return output_filename
        
        return None
        
    except Exception as e:
        print(f"‚ùå L·ªói t·∫°o PDF: {e}")
        return None
