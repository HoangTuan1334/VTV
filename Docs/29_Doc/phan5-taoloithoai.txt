
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHáº¦N 5: Váº¼ Lá»œI THOáº I
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def draw_speech_tail(draw, bubble_x, bubble_y, bubble_width, bubble_height, position="left", color=(255, 255, 255, 240)):
    """Váº½ Ä‘uÃ´i bubble chá»‰ vá» nhÃ¢n váº­t - Há»– TRá»¢ 8 HÆ¯á»šNG"""
    if position == "left":
        # ÄuÃ´i bÃªn trÃ¡i (nhÃ¢n váº­t á»Ÿ bÃªn trÃ¡i)
        tail_points = [
            (bubble_x, bubble_y + bubble_height // 2),
            (bubble_x - 15, bubble_y + bubble_height // 2 + 20),
            (bubble_x, bubble_y + bubble_height // 2 + 15)
        ]
    elif position == "right":
        # ÄuÃ´i bÃªn pháº£i (nhÃ¢n váº­t á»Ÿ bÃªn pháº£i)
        tail_points = [
            (bubble_x + bubble_width, bubble_y + bubble_height // 2),
            (bubble_x + bubble_width + 15, bubble_y + bubble_height // 2 + 20),
            (bubble_x + bubble_width, bubble_y + bubble_height // 2 + 15)
        ]
    elif position == "top-left":
        # ÄuÃ´i gÃ³c trÃªn trÃ¡i (nhÃ¢n váº­t á»Ÿ gÃ³c trÃªn trÃ¡i)
        tail_points = [
            (bubble_x + 20, bubble_y),
            (bubble_x - 10, bubble_y - 15),
            (bubble_x + 35, bubble_y)
        ]
    elif position == "top-right":
        # ÄuÃ´i gÃ³c trÃªn pháº£i (nhÃ¢n váº­t á»Ÿ gÃ³c trÃªn pháº£i)
        tail_points = [
            (bubble_x + bubble_width - 35, bubble_y),
            (bubble_x + bubble_width + 10, bubble_y - 15),
            (bubble_x + bubble_width - 20, bubble_y)
        ]
    elif position == "bottom-left":
        # ÄuÃ´i gÃ³c dÆ°á»›i trÃ¡i (nhÃ¢n váº­t á»Ÿ gÃ³c dÆ°á»›i trÃ¡i)
        tail_points = [
            (bubble_x + 20, bubble_y + bubble_height),
            (bubble_x - 10, bubble_y + bubble_height + 15),
            (bubble_x + 35, bubble_y + bubble_height)
        ]
    elif position == "bottom-right":
        # ÄuÃ´i gÃ³c dÆ°á»›i pháº£i (nhÃ¢n váº­t á»Ÿ gÃ³c dÆ°á»›i pháº£i)
        tail_points = [
            (bubble_x + bubble_width - 35, bubble_y + bubble_height),
            (bubble_x + bubble_width + 10, bubble_y + bubble_height + 15),
            (bubble_x + bubble_width - 20, bubble_y + bubble_height)
        ]
    elif position == "top":
        # ÄuÃ´i á»Ÿ trÃªn (nhÃ¢n váº­t phÃ­a trÃªn)
        tail_points = [
            (bubble_x + bubble_width // 2 - 10, bubble_y),
            (bubble_x + bubble_width // 2, bubble_y - 15),
            (bubble_x + bubble_width // 2 + 10, bubble_y)
        ]
    elif position == "bottom":
        # ÄuÃ´i á»Ÿ dÆ°á»›i (nhÃ¢n váº­t phÃ­a dÆ°á»›i)
        tail_points = [
            (bubble_x + bubble_width // 2 - 10, bubble_y + bubble_height),
            (bubble_x + bubble_width // 2, bubble_y + bubble_height + 15),
            (bubble_x + bubble_width // 2 + 10, bubble_y + bubble_height)
        ]
    else:
        return
    
    # Shadow cho tail
    shadow_tail = [(x + 3, y + 3) for x, y in tail_points]
    draw.polygon(shadow_tail, fill=(0, 0, 0, 80))
    
    # Tail chÃ­nh
    draw.polygon(tail_points, fill=color, outline=(0, 0, 0, 255), width=3)


def draw_character_dialogue(img, dialogues):
    """
    Váº½ bubble lá»i thoáº¡i NHá» Gá»ŒN, Cáº NH nhÃ¢n váº­t, KHÃ”NG CHE Máº¶T
    
    Args:
        img: PIL Image
        dialogues: list of dict:
            [{"character": "An", 
              "text": "HÃ´m nay Ä‘áº¹p trá»i!", 
              "character_position": "bottom-left",  # NhÃ¢n váº­t á»Ÿ Ä‘Ã¢u
              "bubble_position": "top-right",       # Bubble Ä‘áº·t á»Ÿ Ä‘Ã¢u (ngÆ°á»£c láº¡i)
              "tail_direction": "bottom-left"},     # ÄuÃ´i chá»‰ vá» nhÃ¢n váº­t
             ...]
    """
    if not dialogues:
        return img
    
    draw = ImageDraw.Draw(img, 'RGBA')
    w, h = img.size
    
    # MÃ u bubble khÃ¡c nhau cho tá»«ng nhÃ¢n váº­t
    character_colors = {
        "An": (255, 200, 200, 240),      # Há»“ng nháº¡t
        "BÃ¬nh": (200, 220, 255, 240),    # Xanh nháº¡t
        "Chi": (255, 240, 200, 240),     # VÃ ng nháº¡t
        "DÅ©ng": (220, 255, 220, 240),    # Xanh lÃ¡ nháº¡t
        "narrator": (240, 240, 240, 240) # XÃ¡m
    }
    
    # Vá»‹ trÃ­ máº·c Ä‘á»‹nh bubble (Æ¯U TIÃŠN center-top Ä‘á»ƒ an toÃ n)
    default_bubble_positions = {
        "An": "top-right",      # ThÆ°á»ng á»Ÿ dÆ°á»›i trÃ¡i â†’ bubble trÃªn pháº£i
        "BÃ¬nh": "top-left",     # ThÆ°á»ng á»Ÿ dÆ°á»›i pháº£i â†’ bubble trÃªn trÃ¡i
        "Chi": "center-top",    # An toÃ n nháº¥t
        "DÅ©ng": "center-top",   # An toÃ n nháº¥t
        "narrator": "center-top"
    }
    
    # Map tail direction máº·c Ä‘á»‹nh
    default_tail_directions = {
        "An": "bottom-left",
        "BÃ¬nh": "bottom-right",
        "Chi": "bottom",
        "DÅ©ng": "bottom",
        "narrator": "bottom"
    }
    
    # Font nhá» hÆ¡n Ä‘á»ƒ bubble gá»n
    font_size = max(16, min(28, int(w / 28)))  # Giáº£m size: 16-28 (thay vÃ¬ 18-32)
    
    # Load font
    try:
        font = ImageFont.truetype("arial.ttf", font_size)
        font_name = ImageFont.truetype("arialbd.ttf", font_size - 3)
    except:
        try:
            font = ImageFont.truetype("C:\\Windows\\Fonts\\arial.ttf", font_size)
            font_name = ImageFont.truetype("C:\\Windows\\Fonts\\arialbd.ttf", font_size - 3)
        except:
            font = ImageFont.load_default()
            font_name = font
    
    # Váº½ tá»«ng bubble táº¡i vá»‹ trÃ­ cá»¥ thá»ƒ
    for idx, dialogue in enumerate(dialogues):
        char = dialogue.get("character", "narrator")
        text = dialogue.get("text", "")
        
        # Há»– TRá»¢ Cáº¢ FORMAT CÅ¨ VÃ€ Má»šI
        # Format má»›i (Æ°u tiÃªn): bubble_position + tail_direction
        bubble_pos = dialogue.get('bubble_position', None)
        tail_dir = dialogue.get('tail_direction', None)
        
        # Format cÅ©: position
        if not bubble_pos:
            bubble_pos = dialogue.get('position', default_bubble_positions.get(char, "center-top"))
        if not tail_dir:
            tail_dir = default_tail_directions.get(char, "bottom")
        
        if not text:
            continue
        
        # Chá»n mÃ u
        bubble_color = character_colors.get(char, (255, 255, 255, 240))
        
        # âœ¨ BUBBLE NHá» Gá»ŒN HÆ N - chá»‰ vá»«a Ä‘á»§ chá»©a text
        max_bubble_width = int(w * 0.35)  # Tá»‘i Ä‘a 35% (giáº£m tá»« 45%)
        min_bubble_width = int(w * 0.15)  # Tá»‘i thiá»ƒu 15% (giáº£m tá»« 25%)
        padding = 10  # Giáº£m padding tá»« 12 â†’ 10
        
        # Wrap text vá»›i chiá»u rá»™ng Ä‘á»™ng
        words = text.split()
        lines = []
        current_line = ""
        max_line_width = max_bubble_width - padding * 2
        
        for word in words:
            test_line = current_line + word + " "
            try:
                bbox = draw.textbbox((0, 0), test_line, font=font)
                line_width = bbox[2] - bbox[0]
            except:
                line_width = len(test_line) * (font_size // 2)
            
            if line_width <= max_line_width:
                current_line = test_line
            else:
                if current_line:
                    lines.append(current_line.strip())
                current_line = word + " "
        
        if current_line:
            lines.append(current_line.strip())
        
        lines = lines[:3]  # Max 3 dÃ²ng
        
        # TÃ­nh chiá»u rá»™ng thá»±c cá»§a bubble dá»±a trÃªn text dÃ i nháº¥t
        actual_bubble_width = min_bubble_width
        for line in lines:
            try:
                bbox = draw.textbbox((0, 0), line, font=font)
                line_width = bbox[2] - bbox[0] + padding * 2
                actual_bubble_width = max(actual_bubble_width, line_width)
            except:
                pass
        actual_bubble_width = min(actual_bubble_width, max_bubble_width)
        
        # TÃ­nh chiá»u cao
        line_height = font_size + 4  # Giáº£m line spacing
        name_height = font_size - 2 if char != "narrator" else 0
        bubble_height = len(lines) * line_height + padding * 2 + name_height + 3
        
        # âœ¨ Vá»Š TRÃ BUBBLE THÃ”NG MINH - Ä‘áº·t NGÆ¯á»¢C vá»›i nhÃ¢n váº­t Ä‘á»ƒ KHÃ”NG CHE Máº¶T
        margin = 35  # Margin an toÃ n
        
        # PhÃ¢n tÃ­ch bubble_pos Ä‘á»ƒ Ä‘áº·t vá»‹ trÃ­
        if bubble_pos == "center-top":
            # AN TOÃ€N NHáº¤T: bubble giá»¯a trÃªn cÃ¹ng
            bubble_x = (w - actual_bubble_width) // 2
            bubble_y = margin
        elif bubble_pos == "center":
            # Giá»¯a hoÃ n toÃ n
            bubble_x = (w - actual_bubble_width) // 2
            bubble_y = (h - bubble_height) // 2
        elif bubble_pos == "center-bottom":
            # Giá»¯a dÆ°á»›i cÃ¹ng
            bubble_x = (w - actual_bubble_width) // 2
            bubble_y = h - bubble_height - margin
        elif bubble_pos == "top-left":
            # GÃ³c trÃªn trÃ¡i
            bubble_x = margin
            bubble_y = margin
        elif bubble_pos == "top-right":
            # GÃ³c trÃªn pháº£i
            bubble_x = w - actual_bubble_width - margin
            bubble_y = margin
        elif bubble_pos == "bottom-left":
            # GÃ³c dÆ°á»›i trÃ¡i (Ã­t dÃ¹ng vÃ¬ thÆ°á»ng che nhÃ¢n váº­t)
            bubble_x = margin
            bubble_y = h - bubble_height - margin
        elif bubble_pos == "bottom-right":
            # GÃ³c dÆ°á»›i pháº£i (Ã­t dÃ¹ng)
            bubble_x = w - actual_bubble_width - margin
            bubble_y = h - bubble_height - margin
        elif bubble_pos == "left":
            # BÃªn trÃ¡i giá»¯a
            bubble_x = margin
            bubble_y = h // 2 - bubble_height // 2
        elif bubble_pos == "right":
            # BÃªn pháº£i giá»¯a
            bubble_x = w - actual_bubble_width - margin
            bubble_y = h // 2 - bubble_height // 2
        elif bubble_pos == "top":
            # Giá»¯a trÃªn (nhÆ° center-top)
            bubble_x = (w - actual_bubble_width) // 2
            bubble_y = margin
        elif bubble_pos == "bottom":
            # Giá»¯a dÆ°á»›i
            bubble_x = (w - actual_bubble_width) // 2
            bubble_y = h - bubble_height - margin
        else:
            # Máº·c Ä‘á»‹nh: center-top (an toÃ n nháº¥t)
            bubble_x = (w - actual_bubble_width) // 2
            bubble_y = margin
        
        bubble_width = actual_bubble_width
        
        # Váº½ Ä‘uÃ´i bubble TRÆ¯á»šC (Ä‘á»ƒ bubble Ä‘Ã¨ lÃªn) - dÃ¹ng tail_dir
        if tail_dir:
            draw_speech_tail(draw, bubble_x, bubble_y, bubble_width, bubble_height, tail_dir, bubble_color)
        
        # Shadow
        shadow_offset = 3
        draw.rounded_rectangle(
            [bubble_x + shadow_offset, bubble_y + shadow_offset,
             bubble_x + bubble_width + shadow_offset, bubble_y + bubble_height + shadow_offset],
            radius=12,
            fill=(0, 0, 0, 80)
        )
        
        # Bubble chÃ­nh
        draw.rounded_rectangle(
            [bubble_x, bubble_y, bubble_x + bubble_width, bubble_y + bubble_height],
            radius=12,
            fill=bubble_color,
            outline=(0, 0, 0, 255),
            width=3
        )
        
        # TÃªn nhÃ¢n váº­t
        text_y = bubble_y + padding
    `\0099999999999999\
        ;GJSDJGD7``       if char != "narrator":
            draw.text(
                (bubble_x + padding + 5, text_y),
                f"ğŸ’¬ {char}:",
                fill=(80, 80, 80, 255),
                font=font_name
            )
            text_y += name_height + 3
        
        # Ná»™i dung (cÄƒn giá»¯a trong bubble)
        for line in lines:
            try:
                bbox = draw.textbbox((0, 0), line, font=font)
                text_width = bbox[2] - bbox[0]
            except:
                text_width = len(line) * (font_size // 2)
            
            text_x = bubble_x + (bubble_width - text_width) // 2
            
            # Shadow
            draw.text((text_x + 1, text_y + 1), line, fill=(120, 120, 120, 150), font=font)
            # Main
            draw.text((text_x, text_y), line, fill=(0, 0, 0, 255), font=font)
            
            text_y += line_height
    
    return img


def draw_dialogue_bubble(img, dialogue_text, position="top"):
    """Wrapper cÅ© - chuyá»ƒn sang format má»›i"""
    # Chuyá»ƒn Ä‘á»•i sang format má»›i
    dialogues = [{"character": "narrator", "text": dialogue_text}]
    return draw_character_dialogue(img, dialogues)
