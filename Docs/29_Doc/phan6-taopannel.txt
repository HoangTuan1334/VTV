# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHáº¦N 6: Táº O PANEL IMAGES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def create_panel_images(story_script, selected_layouts):
    """Táº¡o áº£nh cho tá»«ng panel"""
    panel_images = {}
    character_references = {}
    os.makedirs("panel_images", exist_ok=True)
    
    for i, page_data in enumerate(story_script['pages']):
        page_num = page_data['page_num']
        
        # ğŸ”§ FIX: TÃ¬m layout theo page_num thay vÃ¬ dÃ¹ng index i
        layout_info = None
        for layout in selected_layouts:
            if layout['page_num'] == page_num:
                layout_info = layout
                break
        
        if layout_info is None:
            print(f"âš ï¸ Cáº¢NH BÃO: KhÃ´ng tÃ¬m tháº¥y layout cho trang {page_num}, bá» qua...")
            continue
        
        is_demo_page = page_data.get('is_demo', False)
        
        # Kiá»ƒm tra sá»‘ panels
        num_panels_in_layout = len(layout_info['panels'])
        num_panels_in_script = len(page_data['panels'])
        
        if num_panels_in_script > num_panels_in_layout:
            print(f"âš ï¸ Trang {page_num}: Cáº¯t {num_panels_in_script} â†’ {num_panels_in_layout} panels")
            page_data['panels'] = page_data['panels'][:num_panels_in_layout]
        
        if is_demo_page:
            print(f"\nğŸ“„ TRANG 0 [DEMO]: {len(page_data['panels'])} panels")
        else:
            print(f"\nğŸ“„ TRANG {page_num}: {len(page_data['panels'])} panels")
        
        page_panels = []
        
        for j, panel_data in enumerate(page_data['panels']):
            panel_num = panel_data['panel_num']
            x, y, w, h = layout_info['panels'][j]
            
            print(f"   ğŸ¨ Panel {panel_num}: {w}x{h}px")
            
            characters_in_panel = panel_data.get('characters_in_panel', [])
            
            # Build character description
            if is_demo_page and panel_data.get('purpose') == 'character_reference':
                char_descriptions = []
                for char_name in characters_in_panel:
                    char_info = next((c for c in story_script['characters'] if c['name'] == char_name), None)
                    if char_info:
                        full_desc = f"{char_name}: {char_info['description']}"
                        char_descriptions.append(full_desc)
                        
                        if char_name not in character_references:
                            character_references[char_name] = char_info['description']
                            print(f"      ğŸ’¾ Reference: {char_name}")
                
                char_desc_text = ", ".join(char_descriptions)
            else:
                char_descriptions = []
                for char_name in characters_in_panel:
                    if char_name in character_references:
                        ref_desc = character_references[char_name]
                        char_descriptions.append(f"The same character {char_name} from page 0 ({ref_desc})")
                    else:
                        char_info = next((c for c in story_script['characters'] if c['name'] == char_name), None)
                        if char_info:
                            char_descriptions.append(f"{char_name} ({char_info['description']})")
                
                char_desc_text = ", ".join(char_descriptions)
            
            # Táº¡o prompt
            if is_demo_page:
                panel_prompt = f"""
{story_script['art_style']} - CHARACTER REFERENCE

{panel_data['visual_prompt']}

CHARACTERS: {char_desc_text}

Vietnamese Independence Day theme, patriotic atmosphere, school setting
NO TEXT/DIALOGUE in image
"""
            else:
                panel_prompt = f"""
{story_script['art_style']}

{panel_data['visual_prompt']}

CHARACTERS (same as page 0): {char_desc_text}

Vietnamese Independence Day celebration theme
Maintain character consistency from page 0
NO TEXT/DIALOGUE in image
"""
            
            # Táº¡o áº£nh vá»›i manual test - KHÃ”NG GIá»šI Háº N sá»‘ láº§n thá»­
            panel_path = f"panel_images/page_{page_num:02d}_panel_{panel_num:02d}.png"
            attempt = 1
            accepted = False
            
            while not accepted:
                try:
                    if attempt > 1:
                        print(f"      ğŸ”„ Thá»­ láº¡i láº§n {attempt}...")
                    
                    panel_img = generate_image_with_gemini(panel_prompt, w, h)
                    
                    # LÆ°u áº£nh gá»‘c (khÃ´ng cÃ³ bubble) Ä‘á»ƒ cÃ³ thá»ƒ váº½ láº¡i
                    original_img = panel_img.copy()
                    
                    # Láº¥y dialogues Ä‘á»ƒ chá»‰nh sá»­a
                    dialogues = panel_data.get('dialogues', [])
                    if not dialogues and panel_data.get('dialogue'):
                        # Format cÅ©: convert sang format má»›i
                        dialogues = [{"character": "narrator", "text": panel_data['dialogue'], "bubble_position": "center-top"}]
                    
                    # Copy dialogues Ä‘á»ƒ chá»‰nh sá»­a
                    editable_dialogues = [d.copy() for d in dialogues]
                    
                    # Váº½ bubble láº§n Ä‘áº§u
                    if editable_dialogues:
                        print(f"      ğŸ’¬ Há»™i thoáº¡i: {len(editable_dialogues)} nhÃ¢n váº­t")
                        for d in editable_dialogues:
                            char = d.get('character', 'narrator')
                            text = d.get('text', '')[:40]
                            print(f"         - {char}: {text}...")
                        panel_img = draw_character_dialogue(original_img.copy(), editable_dialogues)
                    
                    # LÆ°u táº¡m Ä‘á»ƒ preview
                    temp_path = f"panel_images/TEMP_page_{page_num:02d}_panel_{panel_num:02d}.png"
                    panel_img.save(temp_path, quality=100)
                    
                    # YÃªu cáº§u xÃ¡c nháº­n vá»›i tÃ¹y chá»n chá»‰nh sá»­a
                    print(f"\n      {'='*60}")
                    print(f"      ğŸ–¼ï¸  áº¢NH Vá»ªA Táº O:")
                    print(f"      ğŸ“ File: {temp_path}")
                    print(f"      ğŸ“ KÃ­ch thÆ°á»›c: {panel_img.size}")
                    print(f"      ğŸ“ Prompt: {panel_data.get('visual_prompt', '')[:80]}...")
                    print(f"      {'='*60}")
                    
                    # Menu review áº£nh
                    print(f"      ğŸ‘€ Vui lÃ²ng má»Ÿ file vÃ  xem áº£nh!")
                    print(f"      ğŸ“‚ ÄÆ°á»ng dáº«n: {os.path.abspath(temp_path)}")
                    
                    while True:
                        print(f"\n      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
                        print(f"      ğŸ“‹ Lá»°A CHá»ŒN:")
                        print(f"         y - âœ… Cháº¥p nháº­n áº£nh nÃ y")
                        print(f"         n - ğŸ”„ Táº¡o láº¡i áº£nh hoÃ n toÃ n")
                        print(f"         e - âœï¸  Chá»‰nh sá»­a vá»‹ trÃ­ textbox")
                        print(f"         s - â­ï¸  Bá» qua panel nÃ y")
                        print(f"      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
                        
                        choice = input(f"      â“ Lá»±a chá»n cá»§a báº¡n (y/n/e/s): ").strip().lower()
                        
                        if choice == 'y':
                            # Cháº¥p nháº­n - Ä‘á»•i tÃªn file
                            if os.path.exists(panel_path):
                                os.remove(panel_path)
                            os.rename(temp_path, panel_path)
                            
                            page_panels.append({
                                "panel_num": panel_num,
                                "image": panel_img,
                                "path": panel_path,
                                "position": (x, y, w, h)
                            })
                            
                            print(f"      âœ… ÄÃ£ cháº¥p nháº­n vÃ  lÆ°u: {panel_path}\n")
                            accepted = True
                            break
                        
                        elif choice == 'e':
                            # Chá»‰nh sá»­a vá»‹ trÃ­ bubble
                            print(f"\n      âœï¸  CHá»ˆNH Sá»¬A Vá»Š TRÃ TEXTBOX")
                            print(f"      {'='*60}")
                            
                            if not editable_dialogues:
                                print(f"      âš ï¸  Panel nÃ y khÃ´ng cÃ³ lá»i thoáº¡i Ä‘á»ƒ chá»‰nh sá»­a")
                                continue
                            
                            # Hiá»ƒn thá»‹ danh sÃ¡ch nhÃ¢n váº­t
                            print(f"      ğŸ“ Danh sÃ¡ch textbox hiá»‡n táº¡i:")
                            for idx, d in enumerate(editable_dialogues):
                                char = d.get('character', 'narrator')
                                text = d.get('text', '')[:30]
                                current_pos = d.get('bubble_position', d.get('position', 'chÆ°a set'))
                                print(f"         {idx+1}. {char}: '{text}...' â†’ Vá»‹ trÃ­: {current_pos}")
                            
                            # Chá»n textbox Ä‘á»ƒ chá»‰nh
                            while True:
                                try:
                                    bubble_idx = input(f"\n      â“ Chá»n textbox Ä‘á»ƒ chá»‰nh (1-{len(editable_dialogues)}, 0=Xong): ").strip()
                                    bubble_idx = int(bubble_idx)
                                    
                                    if bubble_idx == 0:
                                        # Váº½ láº¡i vá»›i vá»‹ trÃ­ má»›i
                                        print(f"\n      ğŸ¨ Äang váº½ láº¡i textbox vá»›i vá»‹ trÃ­ má»›i...")
                                        panel_img = draw_character_dialogue(original_img.copy(), editable_dialogues)
                                        panel_img.save(temp_path, quality=100)
                                        print(f"      âœ… ÄÃ£ cáº­p nháº­t! Vui lÃ²ng xem láº¡i file: {temp_path}")
                                        break
                                    
                                    if 1 <= bubble_idx <= len(editable_dialogues):
                                        selected_dialogue = editable_dialogues[bubble_idx - 1]
                                        char_name = selected_dialogue.get('character', 'narrator')
                                        
                                        # Hiá»ƒn thá»‹ menu vá»‹ trÃ­
                                        print(f"\n      ğŸ“ Vá»Š TRÃ CÃ“ Sáº´N cho '{char_name}':")
                                        positions = {
                                            '1': ('center-top', 'â¬†ï¸  Giá»¯a trÃªn (an toÃ n nháº¥t)'),
                                            '2': ('top-left', 'â†–ï¸  GÃ³c trÃªn trÃ¡i'),
                                            '3': ('top-right', 'â†—ï¸  GÃ³c trÃªn pháº£i'),
                                            '4': ('center', 'âºï¸  ChÃ­nh giá»¯a'),
                                            '5': ('left', 'â¬…ï¸  BÃªn trÃ¡i giá»¯a'),
                                            '6': ('right', 'â¡ï¸  BÃªn pháº£i giá»¯a'),
                                            '7': ('bottom-left', 'â†™ï¸  GÃ³c dÆ°á»›i trÃ¡i'),
                                            '8': ('bottom-right', 'â†˜ï¸  GÃ³c dÆ°á»›i pháº£i'),
                                            '9': ('center-bottom', 'â¬‡ï¸  Giá»¯a dÆ°á»›i'),
                                        }
                                        
                                        for key, (pos_name, desc) in positions.items():
                                            print(f"         {key}. {desc}")
                                        
                                        pos_choice = input(f"\n      â“ Chá»n vá»‹ trÃ­ má»›i (1-9): ").strip()
                                        
                                        if pos_choice in positions:
                                            new_position, desc = positions[pos_choice]
                                            selected_dialogue['bubble_position'] = new_position
                                            
                                            # Cáº­p nháº­t tail_direction phÃ¹ há»£p
                                            tail_mapping = {
                                                'center-top': 'bottom',
                                                'top-left': 'top-left',
                                                'top-right': 'top-right',
                                                'center': 'bottom',
                                                'left': 'left',
                                                'right': 'right',
                                                'bottom-left': 'bottom-left',
                                                'bottom-right': 'bottom-right',
                                                'center-bottom': 'bottom',
                                            }
                                            selected_dialogue['tail_direction'] = tail_mapping.get(new_position, 'bottom')
                                            
                                            print(f"      âœ… ÄÃ£ cáº­p nháº­t '{char_name}' â†’ {desc}")
                                        else:
                                            print(f"      âš ï¸  Lá»±a chá»n khÃ´ng há»£p lá»‡")
                                    else:
                                        print(f"      âš ï¸  Sá»‘ khÃ´ng há»£p lá»‡. Nháº­p 1-{len(editable_dialogues)} hoáº·c 0")
                                
                                except ValueError:
                                    print(f"      âš ï¸  Vui lÃ²ng nháº­p sá»‘")
                            
                            # Sau khi chá»‰nh xong, quay láº¡i menu chÃ­nh
                            continue
                            
                        elif choice == 'n':
                            # Táº¡o láº¡i
                            print(f"      ğŸ”„ Sáº½ táº¡o láº¡i áº£nh...\n")
                            attempt += 1
                            break
                            
                        elif choice == 's':
                            # Skip - dÃ¹ng áº£nh hiá»‡n táº¡i nhÆ°ng khÃ´ng há»i láº¡i
                            if os.path.exists(panel_path):
                                os.remove(panel_path)
                            os.rename(temp_path, panel_path)
                            
                            page_panels.append({
                                "panel_num": panel_num,
                                "image": panel_img,
                                "path": panel_path,
                                "position": (x, y, w, h)
                            })
                            
                            print(f"      â­ï¸  ÄÃ£ bá» qua vÃ  lÆ°u: {panel_path}\n")
                            accepted = True
                            break
                        else:
                            print(f"      âš ï¸  Vui lÃ²ng nháº­p 'y', 'n', hoáº·c 's'")
                    
                    if accepted or choice == 's':
                        break
                        
                except Exception as e:
                    print(f"      âŒ Lá»—i: {e}")
                    print(f"      ğŸ”„ Sáº½ thá»­ láº¡i sau 3 giÃ¢y...")
                    time.sleep(3)
                    attempt += 1
                    
                    # Há»i ngÆ°á»i dÃ¹ng cÃ³ muá»‘n tiáº¿p tá»¥c thá»­ láº¡i khÃ´ng
                    retry = input(f"\n      â“ Tiáº¿p tá»¥c thá»­ láº¡i? (y=CÃ³/n=Bá» qua panel nÃ y): ").strip().lower()
                    if retry == 'n':
                        print(f"      â­ï¸  Bá» qua panel nÃ y, táº¡o placeholder...")
                        # Táº¡o áº£nh placeholder
                        placeholder = Image.new("RGB", (w, h), "lightgray")
                        draw_obj = ImageDraw.Draw(placeholder)
                        draw_obj.text((w//2, h//2), f"Panel {panel_num}\nBá» qua", fill="black", anchor="mm")
                        
                        placeholder.save(panel_path)
                        
                        page_panels.append({
                            "panel_num": panel_num,
                            "image": placeholder,
                            "path": panel_path,
                            "position": (x, y, w, h)
                        })
                        break
                    # Náº¿u 'y' thÃ¬ tiáº¿p tá»¥c vÃ²ng láº·p while
        
        panel_images[page_num] = page_panels
    
    return panel_images
