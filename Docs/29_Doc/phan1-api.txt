import json
import os
import random
import base64
import time
from PIL import Image, ImageDraw, ImageFont
from pathlib import Path
import google.generativeai as genai
import requests
from io import BytesIO

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHáº¦N 1: Cáº¤U HÃŒNH
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# âš™ï¸ Cáº¥u hÃ¬nh API
GEMINI_API_KEY = "AIzaSyCwhqIs7GrVi1G6wgtejD_w_niFFQws6mo"
genai.configure(api_key=GEMINI_API_KEY)

# Models
text_model = genai.GenerativeModel('gemini-2.0-flash-exp')
try:
    image_model = genai.GenerativeModel('gemini-2.5-flash-image')
    print("âœ… ÄÃ£ cáº¥u hÃ¬nh Gemini API")
except Exception as e:
    print(f"âš ï¸ Lá»—i khá»Ÿi táº¡o image model: {e}")
    image_model = None

# ğŸ“ Cáº¥u hÃ¬nh trang A4 (300 DPI)
PAGE_W, PAGE_H = 2100, 2970
MARGIN = 50
GAP = 20
    "layout_3": [  # 6 khung Ä‘á»u, chia 2x3
        (MARGIN, MARGIN, (PAGE_W//2)-GAP, 950),
        ((PAGE_W//2)+GAP, MARGIN, (PAGE_W//2)-GAP*2, 950),
        (MARGIN, 1000, (PAGE_W//2)-GAP, 950),
        ((PAGE_W//2)+GAP, 1000, (PAGE_W//2)-GAP*2, 950),
        (MARGIN, 2000, (PAGE_W//2)-GAP, 950),
        ((PAGE_W//2)+GAP, 2000, (PAGE_W//2)-GAP*2, 950),
    ],
    "layout_intro": [  # Layout cho trang giá»›i thiá»‡u (6 khung)
        (MARGIN, MARGIN, PAGE_W - 2*MARGIN, 450),
        (MARGIN, 550, (PAGE_W//2)-GAP, 700),
        ((PAGE_W//2)+GAP, 550, (PAGE_W//2)-GAP*2, 700),
        (MARGIN, 1300, (PAGE_W//2)-GAP, 700),
        ((PAGE_W//2)+GAP, 1300, (PAGE_W//2)-GAP*2, 700),
        (MARGIN, 2050, PAGE_W - 2*MARGIN, 850),
    ],
}

# ğŸ‡»ğŸ‡³ Ká»ŠCH Báº¢N Máº¶C Äá»ŠNH - CHá»¦ Äá»€ QUá»C KHÃNH
DEFAULT_STORY = """
Truyá»‡n tranh vá» ká»· niá»‡m 80 nÄƒm Quá»‘c khÃ¡nh Viá»‡t Nam 2/9/1945 - 2/9/2025

CÃ¢u chuyá»‡n xoay quanh nhÃ³m há»c sinh trÆ°á»ng THPT chuáº©n bá»‹ cÃ¡c hoáº¡t Ä‘á»™ng ká»· niá»‡m Quá»‘c khÃ¡nh:

TRANG 0 [DEMO]: Giá»›i thiá»‡u nhÃ¢n váº­t
- Panel 1: Banner "Ká»· niá»‡m 80 nÄƒm Quá»‘c khÃ¡nh 2/9/1945"
- Panel 2-5: 4 há»c sinh chÃ­nh (An, BÃ¬nh, Chi, DÅ©ng) - thÃ nh viÃªn ban tá»• chá»©c
- Panel 6: Khung cáº£nh trÆ°á»ng há»c trang hoÃ ng cá» Ä‘á» sao vÃ ng

TRANG 1: Há»p káº¿ hoáº¡ch
- NhÃ³m há»c sinh há»p bÃ n káº¿ hoáº¡ch tá»• chá»©c lá»… ká»· niá»‡m
- Tháº£o luáº­n cÃ¡c hoáº¡t Ä‘á»™ng: VÄƒn nghá»‡, triá»ƒn lÃ£m áº£nh, thi váº½ tranh, flashmob

TRANG 2: Chuáº©n bá»‹ hoáº¡t Ä‘á»™ng
- CÃ¡c báº¡n cÃ¹ng trang trÃ­ há»™i trÆ°á»ng
- Treo cá» Ä‘á» sao vÃ ng, bÄƒng rÃ´n, poster lá»‹ch sá»­
- Chuáº©n bá»‹ trang phá»¥c Ã¡o dÃ i, Ä‘áº¡o cá»¥ biá»ƒu diá»…n

TRANG 3: Lá»… chÃ o cá»
- Buá»•i lá»… chÃ o cá» trang trá»ng sÃ¡ng ngÃ y 2/9
- Há»c sinh hÃ¡t Quá»‘c ca
- KhÃ´ng khÃ­ nghiÃªm trang, xÃºc Ä‘á»™ng

TRANG 4: Triá»ƒn lÃ£m lá»‹ch sá»­
- Triá»ƒn lÃ£m áº£nh vá» lá»‹ch sá»­ dá»±ng nÆ°á»›c
- CÃ¡c báº¡n giá»›i thiá»‡u tÆ° liá»‡u cho báº¡n bÃ¨
- TÃ¬m hiá»ƒu vá» ngÃ y 2/9/1945 lá»‹ch sá»­

TRANG 5: VÄƒn nghá»‡ chÃ o má»«ng
- Biá»ƒu diá»…n mÃºa, hÃ¡t ca khÃºc yÃªu nÆ°á»›c
- Flashmob cá» Ä‘á» sao vÃ ng giá»¯a sÃ¢n trÆ°á»ng
- KhÃ´ng khÃ­ sÃ´i Ä‘á»™ng, trÃ n Ä‘áº§y niá»m tá»± hÃ o

Káº¾T: Ã nghÄ©a Quá»‘c khÃ¡nh
- NhÃ³m báº¡n cÃ¹ng nhau trÆ°á»›c cá» Tá»• quá»‘c
- Cáº£m nháº­n vá» Ã½ nghÄ©a ngÃ y Quá»‘c khÃ¡nh
- Quyáº¿t tÃ¢m há»c táº­p tá»‘t, Ä‘Ã³ng gÃ³p cho Ä‘áº¥t nÆ°á»›c

Phong cÃ¡ch: Manhwa hiá»‡n Ä‘áº¡i, mÃ u sáº¯c tÆ°Æ¡i sÃ¡ng, tÃ´n vinh tinh tháº§n yÃªu nÆ°á»›c
"""

# ğŸ“ PROMPTS Tá»”NG QUAN CHO Tá»ªNG TRANG (Ä‘á»ƒ xuáº¥t ra)
PAGE_PROMPTS = {
    0: {
        "title": "TRANG 0 - GIá»šI THIá»†U NHÃ‚N Váº¬T [DEMO]",
        "description": "Character reference sheet cho 4 há»c sinh Viá»‡t Nam",
        "panels": [
            "Panel 1: Title banner '80 nÄƒm Quá»‘c khÃ¡nh 2/9/1945-2025' vá»›i cá» Ä‘á» sao vÃ ng",
            "Panel 2: AN - Ná»¯ sinh, tÃ³c dÃ i buá»™c Ä‘uÃ´i ngá»±a, Ã¡o dÃ i tráº¯ng, nÄƒng Ä‘á»™ng",
            "Panel 3: BÃŒNH - Nam sinh, tÃ³c ngáº¯n, Ã¡o tráº¯ng quáº§n tÃ¢y, tá»± tin",
            "Panel 4: CHI - Ná»¯ sinh, tÃ³c ngang vai, Ã¡o dÃ i tráº¯ng, hiá»n lÃ nh",
            "Panel 5: DÅ¨NG - Nam sinh, tÃ³c mÃ¡i chÃ©o, Ã¡o tráº¯ng, phong thÃ¡i lÃ£nh Ä‘áº¡o",
            "Panel 6: Cáº£nh trÆ°á»ng há»c trang hoÃ ng cá» Ä‘á» sao vÃ ng, bÄƒng rÃ´n"
        ],
        "mood": "Reference sheet style, clean, detailed character designs"
    },
    1: {
        "title": "TRANG 1 - Há»ŒP Káº¾ HOáº CH",
        "description": "NhÃ³m báº¡n há»p bÃ n chuáº©n bá»‹ hoáº¡t Ä‘á»™ng ká»· niá»‡m",
        "panels": [
            "Panel 1: Cáº£nh 4 báº¡n ngá»“i quanh bÃ n trong lá»›p há»c, sá»• tay, bÃºt",
            "Panel 2: An Ä‘á»©ng dáº­y trÃ¬nh bÃ y Ã½ tÆ°á»Ÿng (close-up, nhiá»‡t tÃ¬nh)",
            "Panel 3: BÃ¬nh ghi chÃ©p káº¿ hoáº¡ch vÃ o sá»•",
            "Panel 4: Chi vÃ  DÅ©ng tháº£o luáº­n, trÃªn bÃ n cÃ³ báº£n váº½ thiáº¿t káº¿"
        ],
        "mood": "NÄƒng Ä‘á»™ng, hÃ o há»©ng, tinh tháº§n lÃ m viá»‡c nhÃ³m"
    },
    2: {
        "title": "TRANG 2 - CHUáº¨N Bá»Š HOáº T Äá»˜NG",
        "description": "CÃ¡c báº¡n trang trÃ­ há»™i trÆ°á»ng, chuáº©n bá»‹ Ä‘áº¡o cá»¥",
        "panels": [
            "Panel 1: Wide shot - Há»™i trÆ°á»ng rá»™ng, cÃ¡c báº¡n Ä‘ang trang trÃ­",
            "Panel 2: An vÃ  Chi treo bÄƒng rÃ´n 'ChÃ o má»«ng Quá»‘c khÃ¡nh'",
            "Panel 3: BÃ¬nh treo cá» Ä‘á» sao vÃ ng trÃªn cá»™t",
            "Panel 4: DÅ©ng sáº¯p xáº¿p gháº¿, poster lá»‹ch sá»­ trÃªn tÆ°á»ng"
        ],
        "mood": "Táº¥t báº­t, vui váº», cÃ´ng viá»‡c Ä‘ang triá»ƒn khai"
    },
    3: {
        "title": "TRANG 3 - Lá»„ CHÃ€O Cá»œ",
        "description": "Buá»•i lá»… chÃ o cá» trang trá»ng sÃ¡ng 2/9",
        "panels": [
            "Panel 1: Wide shot - SÃ¢n trÆ°á»ng Ä‘Ã´ng há»c sinh xáº¿p hÃ ng ngay ngáº¯n",
            "Panel 2: Cá»™t cá», quá»‘c ká»³ Ä‘á» sao vÃ ng tung bay",
            "Panel 3: Close-up nhÃ³m 4 báº¡n hÃ¡t Quá»‘c ca, nghiÃªm trang",
            "Panel 4: Cáº­n cáº£nh máº·t An, cáº£m xÃºc, Ã¡nh máº¯t tá»± hÃ o"
        ],
        "mood": "Trang trá»ng, xÃºc Ä‘á»™ng, tinh tháº§n yÃªu nÆ°á»›c"
    },
    4: {
        "title": "TRANG 4 - TRIá»‚N LÃƒM Lá»ŠCH Sá»¬",
        "description": "Triá»ƒn lÃ£m áº£nh vá» lá»‹ch sá»­ dá»±ng nÆ°á»›c",
        "panels": [
            "Panel 1: Khu triá»ƒn lÃ£m vá»›i cÃ¡c khung áº£nh lá»‹ch sá»­ trÃªn tÆ°á»ng",
            "Panel 2: Chi giá»›i thiá»‡u áº£nh BÃ¡c Há»“ Ä‘á»c TuyÃªn ngÃ´n Ä‘á»™c láº­p",
            "Panel 3: Há»c sinh khÃ¡c láº¯ng nghe, tÃ² mÃ², ghi chÃº",
            "Panel 4: BÃ¬nh chá»¥p áº£nh ká»· niá»‡m trÆ°á»›c báº£ng triá»ƒn lÃ£m"
        ],
        "mood": "GiÃ¡o dá»¥c, tÃ¬m hiá»ƒu lá»‹ch sá»­, tÃ´n trá»ng"
    },
    5: {
        "title": "TRANG 5 - VÄ‚N NGHá»† CHÃ€O Má»ªNG",
        "description": "Biá»ƒu diá»…n vÄƒn nghá»‡, flashmob cá» Ä‘á» sao vÃ ng",
        "panels": [
            "Panel 1: SÃ¢n kháº¥u - An mÃºa Ã¡o dÃ i, tay cáº§m cá» nhá»",
            "Panel 2: BÃ¬nh vÃ  nhÃ³m hÃ¡t ca khÃºc 'Tiáº¿n quÃ¢n ca'",
            "Panel 3: Wide shot - Flashmob giá»¯a sÃ¢n trÆ°á»ng, hÃ ng chá»¥c há»c sinh cáº§m cá»",
            "Panel 4: Cáº£nh tá»« trÃªn cao - HÃ¬nh ngÃ´i sao 5 cÃ¡nh báº±ng ngÆ°á»i"
        ],
        "mood": "SÃ´i Ä‘á»™ng, vui tÆ°Æ¡i, trÃ n Ä‘áº§y nÄƒng lÆ°á»£ng"
    },
    6: {
        "title": "TRANG 6 - Ã NGHÄ¨A QUá»C KHÃNH",
        "description": "Káº¿t thÃºc - Cáº£m nháº­n vÃ  quyáº¿t tÃ¢m cá»§a cÃ¡c báº¡n",
        "panels": [
            "Panel 1: 4 báº¡n Ä‘á»©ng trÆ°á»›c cá»™t cá», hoÃ ng hÃ´n, cá» Ä‘á» sao vÃ ng pháº¥p phá»›i",
            "Panel 2: Close-up DÅ©ng nÃ³i: 'ChÃºng mÃ¬nh sáº½ há»c táº­p tháº­t tá»‘t'",
            "Panel 3: CÃ¡c báº¡n cÆ°á»i, cháº¡m tay vÃ o nhau (teamwork gesture)",
            "Panel 4: Wide shot - TrÆ°á»ng há»c lÃºc chiá»u tÃ , cá» Ä‘á» sao vÃ ng tung bay"
        ],
        "mood": "Cáº£m Ä‘á»™ng, quyáº¿t tÃ¢m, hy vá»ng tÆ°Æ¡ng lai"
    }
}
# ğŸ¨ LAYOUTS (4-6 khung/trang)
LAYOUTS = {
    "layout_1": [  # 4 khung Ä‘á»u, chia 2x2
        (MARGIN, MARGIN, (PAGE_W//2)-GAP, 1400),
        ((PAGE_W//2)+GAP, MARGIN, (PAGE_W//2)-GAP*2, 1400),
        (MARGIN, 1450, (PAGE_W//2)-GAP, 1400),
        ((PAGE_W//2)+GAP, 1450, (PAGE_W//2)-GAP*2, 1400),
    ],
    "layout_2": [  # 5 khung, 1 to + 4 nhá»
        (MARGIN, MARGIN, PAGE_W - 2*MARGIN, 900),
        (MARGIN, 950, (PAGE_W//2)-GAP, 950),
        ((PAGE_W//2)+GAP, 950, (PAGE_W//2)-GAP*2, 950),
        (MARGIN, 1950, (PAGE_W//2)-GAP, 950),
        ((PAGE_W//2)+GAP, 1950, (PAGE_W//2)-GAP*2, 950),
    ],