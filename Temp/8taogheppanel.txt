# ğŸ“„ GhÃ©p cÃ¡c panel thÃ nh trang hoÃ n chá»‰nh
def compose_page(page_num, panels):
    """
    GhÃ©p cÃ¡c panel thÃ nh má»™t trang A4 hoÃ n chá»‰nh
    """
    # Táº¡o canvas tráº¯ng A4
    page_img = Image.new("RGB", (PAGE_W, PAGE_H), "white")
    
    # DÃ¡n tá»«ng panel vÃ o vá»‹ trÃ­ cá»§a nÃ³
    for panel in panels:
        x, y, w, h = panel['position']
        page_img.paste(panel['image'], (x, y))
    
    # Váº½ viá»n cho cÃ¡c panel
    draw = ImageDraw.Draw(page_img)
    for panel in panels:
        x, y, w, h = panel['position']
        draw.rectangle([x, y, x+w, y+h], outline="black", width=5)
    
    return page_img

# GhÃ©p táº¥t cáº£ cÃ¡c trang (Bá» QUA TRANG 0 - DEMO)
final_pages = []
demo_page_path = None
os.makedirs("final_comic", exist_ok=True)

if 'panel_images' in locals():
    print("\nğŸ“„ Äang ghÃ©p cÃ¡c panel thÃ nh trang...")
    
    for page_num in sorted(panel_images.keys()):
        panels = panel_images[page_num]
        
        print(f"   Trang {page_num}: GhÃ©p {len(panels)} panels...")
        
        page_img = compose_page(page_num, panels)
        
        # LÆ°u trang
        if page_num == 0:
            # TRANG 0: LÆ°u riÃªng vÃ o demo
            page_path = f"final_comic/page_00_DEMO_CHARACTER_REFERENCE.png"
            demo_page_path = page_path
            print(f"   ğŸ“Œ DEMO PAGE - KhÃ´ng tÃ­nh vÃ o truyá»‡n chÃ­nh")
        else:
            # TRANG 1+: Trang truyá»‡n tháº­t
            page_path = f"final_comic/page_{page_num:02d}.png"
            final_pages.append(page_path)
        
        page_img.save(page_path, quality=95)
        print(f"   âœ… ÄÃ£ lÆ°u: {page_path}")
    
    print(f"\nâœ… HoÃ n thÃ nh ghÃ©p {len(panel_images)} trang!")
    print(f"   ğŸ“Œ Trang DEMO: {demo_page_path if demo_page_path else 'KhÃ´ng cÃ³'}")
    print(f"   ğŸ“– Trang truyá»‡n: {len(final_pages)} trang")
else:
    print("âŒ ChÆ°a cÃ³ dá»¯ liá»‡u panel. Vui lÃ²ng cháº¡y láº¡i bÆ°á»›c 5.")





