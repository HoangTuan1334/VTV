import requests
import json
import base64
from openai import OpenAI

# Cáº¥u hÃ¬nh API
AI_API_BASE = "https://api.thucchien.ai/v1"
AI_API_KEY = "AIzaSyDi-soBuW5bmVCncY2ImjtmSONR2AukSng"  # Giá»¯ nguyÃªn key, nhÆ°ng sá»­ dá»¥ng qua API giÃ¡n tiáº¿p

# Khá»Ÿi táº¡o client cho text generation (sá»­ dá»¥ng OpenAI-compatible)
client = OpenAI(
    api_key=AI_API_KEY,
    base_url=AI_API_BASE
)

# Test text generation
print("ğŸ§ª TEST 1: Kiá»ƒm tra Text Generation...")
try:
    response = client.chat.completions.create(
        model="gemini-2.0-flash-exp",  # Giá»¯ model tÆ°Æ¡ng tá»±, giáº£ sá»­ há»— trá»£
        messages=[
            {
                "role": "user",
                "content": "Say hello in 3 words"
            }
        ]
    )
    print(f"âœ… Text Generation: OK")
    print(f"   Response: {response.choices[0].message.content}")
except Exception as e:
    print(f"âŒ Text Generation lá»—i: {e}")
    raise

# Test image generation
print("\nğŸ§ª TEST 2: Kiá»ƒm tra Image Model...")
try:
    url = f"{AI_API_BASE}/images/generations"
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {AI_API_KEY}"
    }
    data = {
        "model": "gemini-2.5-flash-image",  # Giá»¯ model tÆ°Æ¡ng tá»±, giáº£ sá»­ há»— trá»£ (hoáº·c thay báº±ng 'imagen-4' náº¿u cáº§n)
        "prompt": "A simple test image: a red apple on a table",
        "n": 1  # Táº¡o 1 áº£nh Ä‘á»ƒ test
    }

    response = requests.post(url, headers=headers, data=json.dumps(data))
    response.raise_for_status()

    result = response.json()

    # Xá»­ lÃ½ vÃ  lÆ°u áº£nh test
    for i, image_obj in enumerate(result['data']):
        b64_data = image_obj['b64_json']
        image_data = base64.b64decode(b64_data)
        save_path = f"test_image_{i+1}.png"
        with open(save_path, 'wb') as f:
            f.write(image_data)
        print(f"Image saved to {save_path}")

    print(f"âœ… Image Generation: OK")
except Exception as e:
    print(f"âŒ Image Generation lá»—i: {e}")
    if 'response' in locals():
        print(f"Response body: {response.text}")

print("\nâœ… API Key hoáº¡t Ä‘á»™ng tá»‘t!")
print("ğŸ“Œ Text generation sáºµn sÃ ng")
print("ğŸ“Œ Image model: gemini-2.5-flash-image")